<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BPMN Modeler</title>
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <script>
      (function () {
        try {
          const storedTheme = localStorage.getItem('bpmn-theme-preference');
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          const theme = storedTheme ?? (prefersDark ? 'dark' : 'light');
          document.documentElement.dataset.theme = theme === 'dark' ? 'dark' : 'light';
        } catch (error) {
          console.warn('Unable to determine preferred theme during initialization.', error);
          document.documentElement.dataset.theme = 'light';
        }
      })();
    </script>
    <link rel="stylesheet" href="./styles/global.css" />
    <link rel="stylesheet" href="./src/modeler/style.css" />
  </head>
  <body>
    <div class="app">
      <header class="app-header">
        <div class="app-title">
          <div class="app-logo" id="app-logo" hidden></div>
          <span id="diagram-name" data-i18n="diagram.untitled">Untitled diagram</span>
        </div>
        <div class="action-bar">
          <div class="action-group">
            <button
              class="button icon-button primary"
              id="new-diagram"
              type="button"
              data-i18n-attrs="aria-label:actions.newDiagram.ariaLabel,title:actions.newDiagram.title"
            >
              <svg aria-hidden="true" class="icon" viewBox="0 0 24 24" fill="none">
                <path
                  d="M12 5v14M5 12h14"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sr-only" data-i18n="actions.newDiagram.label">New diagram</span>
            </button>
            <button
              class="button icon-button"
              id="save-diagram"
              type="button"
              data-i18n-attrs="aria-label:actions.saveDiagram.ariaLabel,title:actions.saveDiagram.title"
            >
              <svg aria-hidden="true" class="icon" viewBox="0 0 24 24" fill="none">
                <path
                  d="M5 4a2 2 0 0 1 2-2h9.172a2 2 0 0 1 1.414.586l3.828 3.828A2 2 0 0 1 22 7.828V20a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M15 2v6H7V4a2 2 0 0 1 2-2Z"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M8 20h8v-5H8Z"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sr-only" data-i18n="actions.saveDiagram.label">Save diagram</span>
            </button>
            <button
              class="button icon-button"
              id="share-diagram"
              type="button"
              data-i18n-attrs="aria-label:actions.shareDiagram.ariaLabel,title:actions.shareDiagram.title"
            >
              <svg aria-hidden="true" class="icon" viewBox="0 0 24 24" fill="none">
                <path
                  d="M18 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM18 19a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM8 12L14.5 8.5M8 12L14.5 15.5"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sr-only" data-i18n="actions.shareDiagram.label">Share diagram</span>
            </button>
          </div>
          <div class="action-group">
            <button
              class="button icon-button file-browser-toggle"
              id="toggle-storage"
              type="button"
              data-i18n-attrs="aria-label:actions.openStorage.ariaLabel,title:actions.openStorage.title"
            >
              <svg aria-hidden="true" class="icon" viewBox="0 0 24 24" fill="none">
                <path
                  d="M3.75 8.25V6.5A2 2 0 0 1 5.75 4.5h4.1l1.8 1.8H18.5A1.75 1.75 0 0 1 20.25 8.05v9.7A1.75 1.75 0 0 1 18.5 19.5h-13A1.75 1.75 0 0 1 3.75 17.75v-9.5Z"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sr-only" data-i18n="actions.openStorage.label">Open storage</span>
            </button>
          <div class="action-group more-actions-container">
            <button
              class="button icon-button"
              type="button"
              id="more-actions-toggle"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="more-actions-menu"
              aria-label="More actions"
              title="More actions"
            >
              <svg aria-hidden="true" class="icon" viewBox="0 0 24 24" fill="none">
                <circle cx="5" cy="12" r="1.75" fill="currentColor" />
                <circle cx="12" cy="12" r="1.75" fill="currentColor" />
                <circle cx="19" cy="12" r="1.75" fill="currentColor" />
              </svg>
              <span class="sr-only" data-i18n="actions.moreActions.label">More actions</span>
            </button>
            <div class="more-actions-panel hidden" id="more-actions-menu">
              <div class="more-actions-section">
                <button
                  class="button menu-button"
                  id="import-file"
                  type="button"
                  data-close-menu="true"
                  data-i18n-attrs="aria-label:actions.importFile.ariaLabel,title:actions.importFile.title"
                >
                  <svg aria-hidden="true" class="icon" viewBox="0 0 24 24" fill="none">
                    <path
                      d="M12 21V9m0 0l4 4m-4-4l-4 4M5 3h14"
                      stroke="currentColor"
                      stroke-width="1.75"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span data-i18n="actions.importFile.label">Import file</span>
                </button>
                <button
                  class="button menu-button"
                  id="download-diagram"
                  type="button"
                  data-close-menu="true"
                  data-i18n-attrs="aria-label:actions.downloadDiagram.ariaLabel,title:actions.downloadDiagram.title"
                >
                  <svg aria-hidden="true" class="icon" viewBox="0 0 24 24" fill="none">
                    <path
                      d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14"
                      stroke="currentColor"
                      stroke-width="1.75"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span data-i18n="actions.downloadDiagram.label">Download diagram</span>
                </button>
                <button
                  class="button menu-button"
                  id="edit-xml"
                  type="button"
                  data-close-menu="true"
                  data-i18n-attrs="aria-label:actions.editXml.ariaLabel,title:actions.editXml.title"
                >
                  <svg aria-hidden="true" class="icon" viewBox="0 0 24 24" fill="none">
                    <path
                      d="M4 5a2 2 0 0 1 2-2h6l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2Z"
                      stroke="currentColor"
                      stroke-width="1.75"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M14 3v4h4"
                      stroke="currentColor"
                      stroke-width="1.75"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M9 13h6M9 17h6M9 9h2"
                      stroke="currentColor"
                      stroke-width="1.75"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span data-i18n="actions.editXml.label">Edit XML</span>
                </button>
              </div>
              <div class="more-actions-divider" aria-hidden="true"></div>
              <div class="more-actions-section">
                <button
                  class="button menu-button"
                  type="button"
                  id="theme-toggle"
                  aria-pressed="false"
                >
                  <svg aria-hidden="true" class="icon icon-sun" viewBox="0 0 24 24" fill="none">
                    <path
                      d="M12 5V3m0 18v-2m7-7h2M3 12h2m12.364-6.364 1.414-1.414M5.222 18.778l1.414-1.414m0-10.95-1.414-1.414m12.728 12.728-1.414-1.414M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"
                      stroke="currentColor"
                      stroke-width="1.75"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <svg aria-hidden="true" class="icon icon-moon" viewBox="0 0 24 24" fill="none">
                    <path
                      d="M21 12.79A9 9 0 0 1 11.21 3a7 7 0 1 0 9.79 9.79Z"
                      stroke="currentColor"
                      stroke-width="1.75"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <span data-i18n="theme.menuLabel">Theme</span>
                </button>
                <div class="more-actions-language">
                  <label for="language-select" class="more-actions-label" data-i18n="language.label">Language</label>
                  <select id="language-select" class="language-select"></select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <div class="app-body">
        <div class="canvas-wrapper">
          <div id="canvas"></div>
          <div
            class="zoom-controls"
            role="group"
            aria-label="Zoom controls"
            data-i18n-attrs="aria-label:zoom.groupLabel"
          >
            <button
              class="zoom-button"
              type="button"
              id="zoom-in"
              data-i18n-attrs="aria-label:zoom.in,title:zoom.in"
            >
              <svg aria-hidden="true" viewBox="0 0 24 24" fill="none">
                <path
                  d="M12 5v14M5 12h14"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sr-only" data-i18n="zoom.in">Zoom in</span>
            </button>
            <button
              class="zoom-button"
              type="button"
              id="zoom-reset"
              data-i18n-attrs="aria-label:zoom.reset,title:zoom.reset"
            >
              <svg aria-hidden="true" viewBox="0 0 24 24" fill="none">
                <path
                  d="M4 4v6h6"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M5.5 18.5A9 9 0 1 0 7 7"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sr-only" data-i18n="zoom.reset">Reset zoom</span>
            </button>
            <button
              class="zoom-button"
              type="button"
              id="zoom-out"
              data-i18n-attrs="aria-label:zoom.out,title:zoom.out"
            >
              <svg aria-hidden="true" viewBox="0 0 24 24" fill="none">
                <path
                  d="M5 12h14"
                  stroke="currentColor"
                  stroke-width="1.75"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <span class="sr-only" data-i18n="zoom.out">Zoom out</span>
            </button>
          </div>
        </div>
      </div>
      <div id="file-browser" class="file-browser hidden" aria-hidden="true">
        <div class="file-browser-card">
          <div class="file-browser-header">
            <h2 data-i18n="storage.title">Workspace Storage</h2>
            <button class="button" id="close-storage" data-i18n="storage.close">Close</button>
          </div>
          <div class="file-browser-body">
            <div class="tree-view" aria-live="polite">
              <ul id="storage-tree"></ul>
            </div>
            <div class="file-browser-actions">
              <div class="panel-card">
                <h3 data-i18n="storage.saveHeading">Save Diagram</h3>
                <p class="storage-hint" data-i18n="storage.saveHint">Enter a path relative to the workspace root. Create folders as needed.</p>
                <form id="save-form">
                  <div class="input-group">
                    <label for="save-path" data-i18n="storage.savePathLabel">File path</label>
                    <input type="text" id="save-path" data-i18n-attrs="placeholder:storage.savePlaceholder" placeholder="orders/process.bpmn" />
                  </div>
                  <button type="submit" class="small-button primary" data-i18n="storage.saveButton">Save</button>
                </form>
              </div>
              <div class="panel-card">
                <h3 data-i18n="storage.createHeading">Create Folder</h3>
                <form id="folder-form">
                  <div class="input-group">
                    <label for="folder-path" data-i18n="storage.folderPathLabel">Folder path</label>
                    <input type="text" id="folder-path" data-i18n-attrs="placeholder:storage.folderPlaceholder" placeholder="orders/new-folder" />
                  </div>
                  <button type="submit" class="small-button" data-i18n="storage.createButton">Create</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <dialog id="xml-editor-dialog" aria-labelledby="xml-editor-title">
      <form id="xml-editor-form" class="xml-editor" method="dialog">
        <header class="xml-editor-header">
          <h2 id="xml-editor-title" data-i18n="xmlEditor.title">Edit XML</h2>
          <p data-i18n="xmlEditor.description">Make changes to the BPMN XML. Invalid XML cannot be imported.</p>
        </header>
        <div class="xml-editor-body">
          <label for="xml-editor-textarea" data-i18n="xmlEditor.label">Diagram XML</label>
          <textarea id="xml-editor-textarea" class="xml-editor-textarea" spellcheck="false"></textarea>
        </div>
        <div class="xml-editor-error" id="xml-editor-error" role="alert" aria-live="polite"></div>
        <div class="xml-editor-actions">
          <button type="button" class="button" id="xml-editor-cancel" data-i18n="xmlEditor.cancel">Cancel</button>
          <button type="submit" class="button primary" data-i18n="xmlEditor.apply">Apply changes</button>
        </div>
      </form>
    </dialog>
    <dialog id="share-dialog" aria-labelledby="share-dialog-title">
      <form id="share-form" class="share-dialog" method="dialog">
        <header class="share-dialog-header">
          <h2 id="share-dialog-title" data-i18n="share.dialogTitle">Share diagram</h2>
          <p class="share-dialog-description" data-i18n="share.dialogDescription">Choose how you'd like to share this diagram.</p>
        </header>
        <fieldset class="share-options">
          <legend data-i18n="share.optionsLegend">Share options</legend>
          <label class="share-option">
            <input type="radio" name="share-mode" value="source" />
            <span class="share-option-content">
              <span class="share-option-title" data-i18n="share.sourceTitle">Share saved source file</span>
              <span class="share-option-hint" data-i18n="share.sourceHint">Generate a link to the file stored in workspace storage.</span>
            </span>
          </label>
          <label class="share-option">
            <input type="radio" name="share-mode" value="snapshot" checked />
            <span class="share-option-content">
              <span class="share-option-title" data-i18n="share.snapshotTitle">Create snapshot copy</span>
              <span class="share-option-hint" data-i18n-html="share.snapshotHint">Save a timestamped copy in <code>shared/</code> and share that link.</span>
            </span>
          </label>
        </fieldset>
        <div class="share-error" id="share-error" role="alert" aria-live="polite"></div>
        <div class="share-link-group hidden" id="share-link-group">
          <label for="share-link" data-i18n="share.linkLabel">Share link</label>
          <div class="share-link-row">
            <input id="share-link" type="text" readonly />
            <button type="button" class="small-button" id="copy-share-link">Copy link</button>
          </div>
        </div>
        <div class="share-actions">
          <button type="button" class="button" id="share-cancel" data-i18n="share.cancel">Cancel</button>
          <button type="submit" class="button primary" id="share-generate" data-i18n="share.generate">Generate link</button>
        </div>
      </form>
    </dialog>
    <input type="file" id="file-input" accept=".bpmn,.xml" hidden />
    <script type="module" src="/src/modeler/main.js"></script>
  </body>
</html>
